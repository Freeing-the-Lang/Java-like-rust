name: ğŸŒ Open Community Automation (GraphQL Edition)

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  discussions: write

jobs:
  create-discussion:
    name: ğŸ’¬ Auto Create Discussion (GraphQL)
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: ğŸ§­ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ’­ Create Discussion using GraphQL
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const repoInfo = await github.graphql(`
              query {
                repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") {
                  id
                  discussionCategories(first: 10) {
                    nodes { id name }
                  }
                }
              }
            `);
            const repoId = repoInfo.repository.id;
            const category = repoInfo.repository.discussionCategories.nodes.find(c => c.name === "General");
            if (!category) {
              console.log("âš ï¸ No 'General' category found â€” please create one in Discussions first.");
              return;
            }
            const categoryId = category.id;
            const title = `ğŸ—£ï¸ New Commit Discussion â€” ${process.env.GITHUB_SHA.slice(0, 7)}`;
            const body = `
            A new commit was pushed by @${process.env.GITHUB_ACTOR}  
            **Commit message:**  
            ${process.env.GITHUB_HEAD_REF || 'Manual Push'}  
            ---
            SHA: \`${process.env.GITHUB_SHA}\`
            `;
            const mutation = `
              mutation($repoId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
                createDiscussion(input: {
                  repositoryId: $repoId,
                  categoryId: $categoryId,
                  title: $title,
                  body: $body
                }) {
                  discussion { url }
                }
              }
            `;
            const result = await github.graphql(mutation, { repoId, categoryId, title, body });
            console.log("âœ… Discussion created:", result.createDiscussion.discussion.url);

  create-issue:
    name: ğŸª¶ Auto Create Issue on Push
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: ğŸ§­ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§¾ Create linked issue
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "ğŸš€ Update Trigger â€” ${{ github.event.head_commit.message }}"
          content-filepath: .github/ISSUE_TEMPLATE/auto.md
          labels: |
            automation
            discussion-link
          assignees: ${{ github.actor }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  auto-merge:
    name: ğŸ¤ Auto Approve & Merge PRs
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: ğŸ§­ Checkout Repository
        uses: actions/checkout@v4
      - name: âœ… Auto approve & merge PR
        uses: pascalgn/automerge-action@v0.15.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_METHOD: merge
          MERGE_COMMIT_MESSAGE: "ğŸ¤ Auto-merged PR by ${{ github.actor }}"

  summary:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [create-discussion, create-issue, auto-merge]
    steps:
      - name: ğŸ’¬ Log summary
        run: |
          echo "âœ… Discussion and Issue auto-created."
          echo "ğŸ¤ Pull requests auto-approved and merged."
