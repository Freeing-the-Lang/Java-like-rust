name: ğŸŒ Full Open Community Automation

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, closed]
  issues:
    types: [opened]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  discussions: write

jobs:
  auto-discussion:
    name: ğŸ’¬ Auto Open Discussion on Push
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: ğŸ§­ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ’­ Create new discussion for latest commit
        uses: peter-evans/create-discussion@v2
        with:
          title: "ğŸ—£ï¸ New Commit Discussion â€” ${{ github.event.head_commit.message }}"
          body: |
            A new commit was pushed by @${{ github.actor }}  
            **Commit Message:**  
            ```
            ${{ github.event.head_commit.message }}
            ```  
            **SHA:** `${{ github.sha }}`  
            ---
            Use this thread to discuss this change or suggest follow-ups.
          category: "General"

  auto-issue:
    name: ğŸª¶ Auto Create Issue on Push
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: ğŸ§­ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§¾ Create linked issue
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "ğŸš€ Update Trigger â€” ${{ github.event.head_commit.message }}"
          content-filepath: .github/ISSUE_TEMPLATE/auto.md
          labels: |
            automation
            community
          assignees: ${{ github.actor }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  auto-pr:
    name: ğŸ¤ Auto Approve & Merge PRs
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: ğŸ§­ Checkout Repository
        uses: actions/checkout@v4

      - name: âœ… Auto approve & merge PR
        uses: pascalgn/automerge-action@v0.15.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_METHOD: merge
          MERGE_COMMIT_MESSAGE: "ğŸ¤ Auto-merged PR by ${{ github.actor }}"

  notify:
    name: ğŸ“¢ Community Notifications
    runs-on: ubuntu-latest
    needs: [auto-discussion, auto-issue, auto-pr]
    steps:
      - name: ğŸ’¬ Summary
        run: |
          echo "âœ… Community automation executed."
          echo "ğŸ—£ï¸ New discussion and issue created for push by @${{ github.actor }}"
          echo "ğŸ¤ Pull requests auto-approved and merged."
